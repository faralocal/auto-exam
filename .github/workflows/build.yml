name: Build App with Browser

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: Linux_App
            sep: ":"
          - os: windows-latest
            artifact_name: Windows_App.exe
            sep: ";"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        playwright install chromium

    # --- مرحله مخصوص لینوکس ---
    - name: Build on Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        # پیدا کردن مسیر نصب شده کرومیوم
        CHROMIUM_PATH=$(find ~/.cache/ms-playwright -name "chromium-*" -type d | head -n 1)
        FOLDER_NAME=$(basename "$CHROMIUM_PATH")
        echo "Found Chromium at: $CHROMIUM_PATH"
        
        # اجرای پای‌اینستالر
        pyinstaller --noconfirm --onefile --console --name "AutoBrowser_Linux" \
          --add-data "static${{ matrix.sep }}static" \
          --add-data "$CHROMIUM_PATH${{ matrix.sep }}pw-browsers/$FOLDER_NAME" \
          app.py

    # --- مرحله مخصوص ویندوز ---
    - name: Build on Windows
      if: matrix.os == 'windows-latest'
      run: |
        # پیدا کردن مسیر کرومیوم با پاورشل
        $CHROMIUM_PATH = Get-ChildItem -Path "$env:LOCALAPPDATA\ms-playwright\chromium-*" -Directory | Select-Object -First 1 -ExpandProperty FullName
        $FOLDER_NAME = Split-Path $CHROMIUM_PATH -Leaf
        Write-Host "Found Chromium at: $CHROMIUM_PATH"
        
        # اجرای پای‌اینستالر
        pyinstaller --noconfirm --onefile --console --name "AutoBrowser_Windows" `
          --add-data "static${{ matrix.sep }}static" `
          --add-data "$CHROMIUM_PATH${{ matrix.sep }}pw-browsers\$FOLDER_NAME" `
          app.py

    # --- آپلود فایل نهایی به عنوان Artifact (برای دانلود موقت) ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/
        retention-days: 5

    # --- (اختیاری و جذاب) آپلود خودکار فایل‌ها به صفحه Release ---
    # این مرحله فایل‌های exe را مستقیم می‌چسباند به همان ریلیزی که ساختید
    - name: Upload binaries to Release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: dist/*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
